This is technical documentation for vulnerability_assessment.ipynb in support of vulnerability assessments, including mandated CAVA reports for utilities.
Details within the methodology below provide greater context per each of the "main" kinds of metric calculations, 
as well as how global warming level based approach works computationally. 

For more detailed code, please see these computational scripts:
<br> [Threshold tools](https://github.com/cal-adapt/climakitae/blob/main/climakitae/explore/threshold_tools.py)
<br> [Vulnerability](https://github.com/cal-adapt/climakitae/blob/main/climakitae/explore/vulnerability.py)
<br> [Warming](https://github.com/cal-adapt/climakitae/blob/main/climakitae/explore.warming.py)

This document is *in progress* and will update frequently as additional details are added. 

v1 - September 2024

Methodology
===========
1-in-X temperature events
-------------------------
Example: 1-in-10 year maximum temperature

Arguments:
    <br>**one_in_x**: The return period ("X") is determined by the "one_in_x" argument, where "x" is the desired return period, and is required user input. Options are numerical.
    <br>**metric_calc**: Max/min denotes whether the daily minimum or maximum is desired (daytime high vs. nighttime low), where "metric_calc" is a required user input. Options are "min" and "max".
    <br>**distr**: The goodness of fit distribution, and is an optional user input. Default is set to the generalized extreme value ("gev" distribution). Options are "gev", "gumbel", "weibull", "pearson3", "genpareto", "gamma". Please see the [threshold tools notebook](https://github.com/cal-adapt/cae-notebooks/blob/main/work_in_progress/threshold_basics.ipynb) for more information. 

Order of operations:
    <br>1. Data is passed to the `get_block_maxima` threshold tools function in climakitae, for each simulation, with the "metric_calc" (min/max) is passed to the "extremes_type" parameter. Data is grouped by 1 day increments to calculate the annual maximum series for temperature events.
    <br>2. Annual maximum series is passed to the `get_return_value` thresholds tool function in climakitae, where the "one_in_x" argument is passed to the "return_period" parameter. 
    <br>3. Return periods per simulation are concatenanted back into a single data object.
    <br>4. Data is returned.


Likely seasonal events
----------------------
Example: likely summer night low temperature

Arguments:
    <br>**percentile**: Likelihood is determined by percentile, where the "percentile" argument is required user input. Options are 0-100. 
    <br>**season**: Season is denoted by meteorological seasons (starting on 1st of month), where "season" is required user input. Options are "winter", "summer", "all".
    Winter is December, January, February (DJF); Summer is June, July, August (JJA); All is January through February (all months).
    <br>**metric_calc**: Max/min denotes whether the daily minimum or maximum is desired (daytime high vs. nighttime low), where "metric_calc" is a required user input. Options are "min" and "max".

Order of operations:
    <br>1. In data retrieval process, data is subsetted based on season argument. 
    <br>2. Data is resampled to a daily timestep if it is not already at daily temporal resolution, with the "metric_calc" (min/max) argument determining how the data is reduced.
    <br>3. Percentile is calculated to determine likelihood of occurrence. 
    <br>4. Data is returned. 


High Heat Index events
-----------------------
Example: how many days per year does the Heat Index exceed 90°F

Arguments:
    <br>**metric_calc**: Max/min denotes whether the daily minimum or maximum is desired (daytime high vs. nighttime low), where "metric_calc" is a required user input. Options are "min" and "max".
    <br>**heat_idx_threshold**: Threshold for heat index exceedance, where "heat_idx_threshold" is a required user input. Options are numerical. 

Order of operations:
    <br>1. Data is resampled to a daily timestep, with the number of events exceeding the "heat_idx_threshold" argument against the "metric_calc" (min/max) argument determining how the data is reduced. 
    <br>2. Data is then resampled a second time to an annual timestep by summing the number of events per year. 
    <br>3. Data is returned. 

Note: Heat Index can only be calculated with dynamically-downscaled data (WRF) due to the required input variables of air temperature and relative humidity available at hourly timescales.


1-in-X precipitation events
---------------------------
Example: 1-in-100 year, 24-hour precipitation; 1-in-10 year, 3-hour precipitation

Arguments:
    <br>**one_in_x**: The return period ("X") is determined by the "one_in_x" argument, where "x" is the desired return period, and is required user input. Options are numerical.
    <br>**metric_calc** Max/min denotes whether the daily minimum or maximum is desired (daytime high vs. nighttime low), where "metric_calc" is a required user input. Options are "min" and "max".
    <br>**distr**: The goodness of fit distribution, and is an optional user input. Default is set to the generalized extreme value ("gev" distribution). Options are "gev", "gumbel", "weibull", "pearson3", "genpareto", "gamma". Please see the [threshold tools notebook](https://github.com/cal-adapt/cae-notebooks/blob/main/work_in_progress/threshold_basics.ipynb) for more information. 
    <br>**event_freq**: The duration of event, and is an optional user input. Default is set to (1, "day") for a 24-hour event. Options are numerical for the event length (first item in tuple), and "day" or "hour" for the temporal frequency (second item in tuple). Example of an alternative event duration would be: (72, "hour"). 

Order of operations:
    <br>1. Data is passed to the `get_block_maxima` threshold tools function in climakitae, for each simulation, with the "metric_calc" (min/max) is passed to the "extremes_type" parameter. Data is grouped by the "event_freq" increments to calculate the annual maximum series for precipitation events.
    <br>2. Annual maximum series is passed to the `get_return_value` thresholds tool function in climakitae, where the "one_in_x" argument is passed to the "return_period" parameter, and the "distr" argument is passed to the "distr" parameter. 
    <br>3. Return values per simulation are concatenanted back into a single data object.
    <br>4. Goodness of fit is calculated and returned for 1-in-X precipitation events, and added as an attribute to the final data object. 
    <br>4. Data is returned.

Note: 
    <br>1. For daily precipitation 1-in-X events (i.e., 24-hour), we recommend the use of LOCA2 data instead of WRF data. If looking for a non-24-hour event, WRF data must be used, as the LOCA2 data is not available at hourly time steps.
    <br>2. The goodness of fit on the distribution is provided for 1-in-X precipitation events. The p-value of the distribution fit to the data is provided during the calculation step and as an attribute in the final data object. For 1-in-X precipitation events, **we recommend the use of "gev" as the distribution** for the first distribution test. GEV allows for a continuous range of different shapes, and will reduce to either Gumbel, Weibull, or Generalized Pareto distributions under different conditions. GEV is typically a better fit than the 3 individaul distributions, and is a common distribution in hydrological applications. If the **p-value is less than 0.05**, this indicates that the selected distribution is **not a good fit for the data**, and we recommend choosing a different distribution and re-running the cava_data function.
    <br>3. In certain geographic regions, the selection of a high return period event (e.g., 1-in-1000) may produce unrealistically high precipitation values. This is a limitation of the data sample size beyond what the data can reasonably estimate, where a small change in noise will produce a large change in the distribution tails.

Warming Levels
---------------
Example: 2°C warming level

Arguments:
    <br>**approach**: Warming level approach is designated by the "approach" argument, and is required user input. Options are "time" for time-based approach, and "warming_level" for GWL approach.
    <br>**warming_level**: The desired global warming level is determined by the "warming_level" argument, and is required user input. Options are 1.5, 2.0, 2.5, and 3.0.

Order of operations:
    <br>1. Warming levels data is retrieved via the `warming_levels` functionality in climakitae. 
    <br>2. Warming levels data is a 30-year window centered around the year that each individual simulation exceeds the designated warming level, based on the "warming_level" argument. The 30-year window is (center_year - 15 years, center_year, center_year + 14 years).
    <br>3. A synthetic "time" dimension is added back to the data object in order to calculate metrics (which typically need "time" as a dimension to resample). 
    <br>4. Data is passed to the requested metric. 
